(function(e){e.fn.rotatable=function(t){var n={rotatorClass:"ui-rotatable-handle",mtx:[1,0,0,1]},r=e.extend(n,t),s=this,o=e("#url_site").val(),u;this.intialize=function(){this.createHandler();dims={w:s.width(),h:s.height()}};this.createHandler=function(){u=e('<div class="'+r.rotatorClass+'"></div>');s.append(u);this.bindRotation()};this.bindRotation=function(){u.draggable({revert:true,start:function(e){e.stopPropagation();e.stopImmediatePropagation();tl_coords={x:parseInt(s.parent().css("left")),y:parseInt(s.parent().css("top"))};dims={w:s.width(),h:s.height()};center_coords={x:s.offset().left+s.width()*.5,y:s.offset().top+s.height()*.5};begin_angle_pos={x:s.offset().left+s.width(),y:s.offset().top};begin_angle=s.radToDeg(s.getAngle(begin_angle_pos,center_coords));old_angle=s.attr("angle2");id=s.find("img").attr("rel");begin_angle2=parseFloat(begin_angle)+parseFloat(old_angle)},drag:function(t){t.stopPropagation();t.stopImmediatePropagation();mouse_coords={x:t.pageX,y:t.pageY};angle=s.radToDeg(s.getAngle(mouse_coords,center_coords))-begin_angle;s.attr("angle",angle);new_angle=parseFloat(old_angle)+angle;s.attr("angle2",new_angle%360);new_angle2=new_angle%360;var n,r;if(new_angle2==90){new_angle2=89.9999999999}var i=s.attr("w"),o=s.attr("h"),u=s.attr("pos").split(",");var a=new_angle2*Math.PI/180;var f=Math.cos(a);var l=Math.sin(a);if(f<0){f=-f}if(l<0){l=-l}n=o*l+i*f;r=o*f+i*l;var c=n-i,h=r-o;s.css({left:parseInt(u[0]-c/2-i/2),top:parseInt(u[1]-h/2-o/2)});s.children("img").css({left:parseInt(c/2),top:parseInt(h/2),position:"absolute"});s.width(n).height(r);e(".overlay-btn").removeClass("send-back");return s.rotate(new_angle%360)},stop:function(e,t){}})};this.getAngle=function(e,t){var n=e.x-t.x,r=-e.y+t.y,i=Math.sqrt(Math.pow(n,2)+Math.pow(r,2)),s=Math.acos(n/i);if(r<0){s=2*Math.PI-s}return s};this.degToRad=function(e){return e*(Math.PI/180)};this.radToDeg=function(e){return e*(180/Math.PI)};this.rotate=function(e){var t=Math.cos(s.degToRad(-e)),n=Math.sin(s.degToRad(-e)),r=[t,n,-n,t];this.updateRotationMatrix(r,e)};this.getRotationMatrix=function(){var e=s.css("transform")?s.css("transform"):"rotate(0deg)";_m=e.split(","),m=[];for(i=0;i<4;i++){m[i]=parseFloat(_m[i].replace("matrix(",""))}return m};this.updateRotationMatrix=function(e,t){var n=t*-1;var r="progid:DXImageTransform.Microsoft.Matrix(M11='"+e[0]+"', M12='"+e[1]+"', M21='"+e[2]+"', M22='"+e[3]+"', sizingMethod='auto expand')",i=s.attr("scx"),o=s.attr("scy");s.find("img").css({"-moz-transform":"rotate("+n+"deg) scaleX("+i+") scaleY("+o+")","-o-transform":"rotate("+n+"deg) scaleX("+i+") scaleY("+o+")","-webkit-transform":"rotate("+n+"deg) scaleX("+i+") scaleY("+o+")","-ms-transform":"rotate("+n+"deg) scaleX("+i+") scaleY("+o+")",transform:"rotate("+n+"deg) scaleX("+i+") scaleY("+o+")",filter:r,"-ms-filter":'"'+r+'"'})};return this.intialize()}})(jQuery)